<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Karaoke</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          crossorigin="anonymous">
    <style>
        .line {
            font-size:96px;
            font-weight:bold;
            color:transparent;
            background-clip:text!important;
        }

        #countdown {
            font-size:28em;
            font-weight:bold;
            color:#FAFAFA;
        }
    </style>
</head>
<body class="d-flex flex-column w-100 justify-content-center align-items-center" th:style="'height:100vh;background:url(' + @{/images/background_1.jpg} + ') no-repeat center center fixed;background-size:cover'">
<audio id="audio">
    <source th:src="${track.gameModes.get(gameMode).src}" type="audio/mpeg">
</audio>
<div class="m-3">
    <div id="play">
        <svg width="173.20" height="200" viewBox="0 0 86.6 100">
            <path d="M 0 0 l 86.6 50, -86.6 50 z" fill="#FAFAFA" />
        </svg>
    </div>
    <div id="lines" class="collapse">
        <p class="text-center">
            <span id="first-line" class="line p-1"></span>
        </p>
        <p class="text-center">
            <span id="second-line" class="line p-1"></span>
        </p>
    </div>
    <p id="countdown" class="collapse"></p>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
        const track = /*[[${track}]]*/ undefined;
        const gameMode = /*[[${gameMode}]]*/ undefined;
    /*]]>*/
</script>
<script>
    const sendGet = (url) => {
        const xmlHttp = new XMLHttpRequest();

        xmlHttp.open("GET", url, false);
        xmlHttp.send(null);

        return xmlHttp.responseText === "true";
    };

    const linesElem      = document.getElementById('lines');
    const countdownElem  = document.getElementById('countdown');
    const firstLineElem  = document.getElementById('first-line');
    const secondLineElem = document.getElementById('second-line');
    const audioElem      = document.getElementById('audio');
    const playElem       = document.getElementById('play');

    const text = track.gameModes[gameMode].text;

    const commands = [];

    for (let c of track.gameModes[gameMode].commands) {
        const m1 = c.match(/\{(\d+);(\d+(\.\d+)?)\}speed=(\d+(\.\d+)?)/);
        const m2 = c.match(/\{(\d+);(\d+(\.\d+)?)\}pause=(\d+(\.\d+)?)/);
        const m3 = c.match(/\{(\d+);(\d+(\.\d+)?)\}countdown=(\d+(\.\d+)?)/);
        const m4 = c.match(/\{(\d+);(\d+(\.\d+)?)\}show/);
        const m5 = c.match(/\{(\d+);(\d+(\.\d+)?)\}hide/);

        if (m1) {
            const line  = m1[1] * 1;
            const pos   = m1[2] * 1;
            const value = m1[4] * 1;

            commands.push((l, p) => {
                if (line === l && p >= pos) {
                    return {"speed": value};
                }

                return false;
            });
        } else if (m2) {
            const line  = m2[1] * 1;
            const pos   = m2[2] * 1;
            const value = m2[4] * 1;

            commands.push((l, p) => {
                if (line === l && p >= pos) {
                    return {"pause": value * 1000};
                }

                return false;
            });
        } else if (m3) {
            const line  = m3[1] * 1;
            const pos   = m3[2] * 1;
            const value = m3[4] * 1;

            commands.push((l, p) => {
                if (line === l && p >= pos) {
                    return {"countdown": value};
                }

                return false;
            });
        } else if (m4) {
            const line  = m4[1] * 1;
            const pos   = m4[2] * 1;

            commands.push((l, p) => {
                if (line === l && p >= pos) {
                    return {"show": true};
                }

                return false;
            });
        } else if (m5) {
            const line  = m5[1] * 1;
            const pos   = m5[2] * 1;

            commands.push((l, p) => {
                if (line === l && p >= pos) {
                    return {"hide": true};
                }

                return false;
            });
        }
    }

    playElem.addEventListener('click', async () => {
        playElem.className = 'collapse';

        await new Promise(resolve => setTimeout(resolve, 1000));

        audioElem.volume = 0.5;
        audioElem.play();

        let commandIndex = 0;

        let line = 0;
        let p1 = 0;
        let p2 = 0;
        let speed = 1;
        let pauseInit = 0;
        let pause = 0;
        let show = false;
        let hide = false;
        let keepShowing = false;
        let countdownStarted = false;
        let countdown = -1;
        let secondLine = false;

        let w1;
        let w2;
        let w3;

        const interval = await setInterval(() => {
            if (countdown >= 0 && (pauseInit - pause) % 1000 == 0) {
                if (countdown > 0) {
                    countdownElem.innerHTML = countdown;
                } else {
                    countdownElem.className = 'collapse';
                }

                countdown--;
            }

            if (pause > 0) {
                pause -= 10;
                return;
            }

            if (line >= text.length) {
                clearInterval(interval);

                audioElem.pause();
                audioElem.currentTime = 0;

                const interval2 = setInterval(() => {
                    const response = sendGet("/play/ping");

                    if (response) {
                        clearInterval(interval2);
                        window.location = "/answers";
                    }
                }, 10);

                return;
            }

            const params = commandIndex == commands.length ? false : commands[commandIndex](line, secondLine ? p2 : p1);

            if (params) {
                if ('speed' in params) {
                    speed = params['speed'];
                } else if ('pause' in params) {
                    pause = params['pause'];
                } else if ('countdown' in params) {
                    pause            = params['countdown'] * 1000 + 500;
                    pauseInit        = params['countdown'] * 1000 + 500;
                    countdown        = params['countdown'];
                    countdownStarted = true;
                } else if ('show' in params) {
                    show = params['show'];
                    keepShowing = true;
                } else if ('hide' in params) {
                    hide = params['hide'];
                    keepShowing = false;
                }

                commandIndex++;
            }

            if (countdownStarted) {
                countdownStarted = false;

                countdownElem.className = '';
                countdownElem.innerHTML = '';

                return;
            }

            if (pause > 0) {
                return;
            }

            if (show) {
                show = false;
                secondLine = false;
                p1 = 0;
                p2 = 0;

                linesElem.className = 'd-flex flex-column justify-content-center align-items-center';

                firstLineElem.innerHTML  = text[line];
                secondLineElem.innerHTML = text[line + 1];

                firstLineElem.style  = 'white-space:nowrap';
                secondLineElem.style = 'white-space:nowrap';

                w1 = firstLineElem.offsetWidth * 1;
                w2 = secondLineElem.offsetWidth * 1;
                w3 = w1;

                firstLineElem.style  = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p1 + 'px, rgb(255, 255, 255) 0);';
                secondLineElem.style = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p2 + 'px, rgb(255, 255, 255) 0);';

                return;
            }

            if (hide) {
                hide = false;
                linesElem.className = 'd-flex flex-column justify-content-center align-items-center collapse';

                return;
            }

            if (keepShowing) {
                if (p1 >= w3) {
                    secondLine = true;
                    line++;

                    if (line >= text.length) {
                        return;
                    }

                    p2 = 0;
                    w3 = w1 + w2;
                } else if (p2 >= w2) {
                    secondLine = false;
                    p1 = 0;
                    p2 = 0;

                    line++;

                    if (line >= text.length) {
                        return;
                    }

                    if (line < text.length) {
                        firstLineElem.innerHTML = text[line];
                    }

                    if (line < text.length - 1) {
                        secondLineElem.innerHTML = text[line + 1];
                    }

                    firstLineElem.style  = 'white-space:nowrap';
                    secondLineElem.style = 'white-space:nowrap';

                    w1 = firstLineElem.offsetWidth * 1;
                    w2 = secondLineElem.offsetWidth * 1;
                    w3 = w1;

                    firstLineElem.style  = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p1 + 'px, rgb(255, 255, 255) 0);';
                    secondLineElem.style = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p2 + 'px, rgb(255, 255, 255) 0);';
                } else {
                    firstLineElem.style  = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p1 + 'px, rgb(255, 255, 255) 0);';
                    secondLineElem.style = 'background:linear-gradient(90deg, rgb(0, 200, 83) 0, rgb(0, 200, 83) ' + p2 + 'px, rgb(255, 255, 255) 0);';

                    if (secondLine) {
                        p2 += speed;
                    } else {
                        p1 += speed;
                    }
                }
            }
        }, 10);
    });
</script>
</body>
</html>